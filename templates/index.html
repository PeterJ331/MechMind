<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MechMind</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-link { cursor: pointer; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .sidebar { min-height: 100vh; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid">
  <div class="row">
    <!-- å·¦ä¾§å¯¼èˆª -->
    <nav class="col-md-2 bg-white border-end sidebar p-3">
      <div class="text-start mb-4">
        <img src="{{ url_for('static', filename='logo-1.png') }}" alt="MechMind Logo" style="height: 120px;">
      </div>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item mb-2"><a class="nav-link active" onclick="showSection('chat-section')">ğŸ’¬ èŠå¤©</a></li>
        <li class="nav-item mb-2"><a class="nav-link" onclick="showSection('file-section')">ğŸ“ ä»“åº“</a></li>
        <li class="nav-item mb-2"><a class="nav-link" onclick="showSection('voice-section')">ğŸ™ï¸ è¯­éŸ³</a></li>
        <li class="nav-item mb-2"><a class="nav-link" onclick="showSection('excel-section')">ğŸ“Š Excel</a></li>
        <li class="nav-item mb-2"><a class="nav-link" onclick="showSection('model-config-section')">âš™ï¸ æ¨¡å‹é€‰æ‹©</a></li>
      </ul>
    </nav>

    <!-- å³ä¾§å†…å®¹ -->
    <main class="col-md-10 p-4">
      <!-- èŠå¤©æ¨¡å— -->
      <div id="chat-section"
           class="content-section active flex-column {% if not answer %}d-flex align-items-center justify-content-center{% endif %}"
           style="min-height: 80vh;">

        {% if not answer %}
          <!-- Logo å±…ä¸­æ˜¾ç¤º -->
          <div class="text-center my-4">
            <img src="{{ url_for('static', filename='logo-1.png') }}" alt="Logo" style="height: 400px;">
          </div>

          <!-- æ¨èæé—®æ°”æ³¡æ¡† -->
          <div class="d-flex flex-wrap justify-content-center gap-2 mb-4">
            <button class="btn btn-outline-secondary rounded-pill" onclick="presetQuestion('æœºæ¢°è£…å¤‡è¯´æ˜ä¹¦ä¸€èˆ¬åŒ…å«å“ªå‡ éƒ¨åˆ†ï¼Ÿ')">æœºæ¢°è£…å¤‡è¯´æ˜ä¹¦ä¸€èˆ¬åŒ…å«å“ªå‡ éƒ¨åˆ†ï¼Ÿ</button>
            <button class="btn btn-outline-secondary rounded-pill" onclick="presetQuestion('ä»€ä¹ˆæ˜¯LLMï¼Ÿ')">ä»€ä¹ˆæ˜¯LLMï¼Ÿ</button>
            <button class="btn btn-outline-secondary rounded-pill" onclick="presetQuestion('ä»‹ç»ä¸‹éæ ‡è®¾è®¡çš„ç‰¹ç‚¹')">ä»‹ç»ä¸‹éæ ‡è®¾è®¡çš„ç‰¹ç‚¹</button>
            <button class="btn btn-outline-secondary rounded-pill" onclick="presetQuestion('å¸®æˆ‘å†™è®¾å¤‡æ“ä½œè¯´æ˜ä¹¦')">å¸®æˆ‘å†™è®¾å¤‡æ“ä½œè¯´æ˜ä¹¦</button>
          </div>
        {% endif %}

        <!-- ä¸­å¤®æé—®è¾“å…¥æ¡†ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
        <form action="/ask" method="post" class="w-75 mb-3">
          <div class="input-group input-group-lg shadow-sm">
            <input type="text" name="question" class="form-control rounded-start-pill border-end-0" placeholder="ä½ æƒ³çŸ¥é“ä»€ä¹ˆï¼Ÿ" required>
            <button class="btn btn-success rounded-end-pill px-4">æé—®</button>
          </div>
        </form>

        <!-- æ¨¡å‹å›ç­”å±•ç¤º -->
        {% if answer %}
        <div class="alert alert-info w-75"><strong>ğŸ¤– æ¨¡å‹å›ç­”ï¼š</strong><br>{{ answer }}</div>
        {% endif %}

<!--        &lt;!&ndash; ä¸‹è½½ Markdown &ndash;&gt;-->
<!--        {% if markdown_file %}-->
<!--        <div class="mt-3">-->
<!--          <a href="{{ url_for('download_markdown', filename=markdown_file) }}" class="btn btn-outline-success">ğŸ“¥ ä¸‹è½½ Markdown</a>-->
<!--        </div>-->
<!--        {% endif %}-->
        <!-- ä¸‹è½½ Markdown -->
        {% if answer %}
        <div class="mt-3">
          <a href="{{ url_for('download_markdown_live') }}" class="btn btn-outline-success">ğŸ“¥ ä¸‹è½½ Markdown</a>
        </div>
        {% endif %}


        <!-- å¼•ç”¨èµ„æ–™ -->
        {% if source_chunks %}
        <div class="card border-info mt-4 w-75">
          <div class="card-header bg-info text-white">ğŸ“„ å¼•ç”¨èµ„æ–™ç‰‡æ®µï¼ˆTop {{ source_chunks|length }}ï¼‰</div>
          <div class="card-body">
            <div class="accordion" id="ragAccordion">
              {% for chunk in source_chunks %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                    ğŸ“ ç‰‡æ®µ {{ loop.index }}
                  </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#ragAccordion">
                  <div class="accordion-body bg-light">
                    <pre style="white-space: pre-wrap; font-size: 14px;">{{ chunk }}</pre>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyToClipboard('chunkTxt{{ loop.index }}')">ğŸ“‹ å¤åˆ¶</button>
                    <textarea id="chunkTxt{{ loop.index }}" class="d-none">{{ chunk }}</textarea>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>

<!--      <div id="chat-section" class="content-section active">-->
<!--        <div class="card mb-4">-->
<!--          <div class="card-header">ğŸ’¬ èŠå¤©é—®ç­”ï¼ˆæ”¯æŒæœ¬åœ° / äº‘ç«¯æ¨¡å‹ï¼‰</div>-->
<!--          <div class="card-body">-->
<!--            <form action="/ask" method="post" class="row g-3">-->
<!--              <div class="col-md-10">-->
<!--                <input type="text" name="question" class="form-control" placeholder="è¯·è¾“å…¥é—®é¢˜..." required>-->
<!--              </div>-->
<!--              <div class="col-md-2">-->
<!--                <button class="btn btn-success w-100">æé—®</button>-->
<!--              </div>-->
<!--            </form>-->



<!--            {% if voice_text %}-->
<!--            <div class="alert alert-warning mt-3">-->
<!--              <strong>ğŸ“ è¯­éŸ³è¯†åˆ«å†…å®¹ï¼š</strong> {{ voice_text }}-->
<!--              <button class="btn btn-sm btn-outline-dark ms-2" onclick="copyText()">å¤åˆ¶</button>-->
<!--            </div>-->
<!--            {% endif %}-->

<!--            {% if answer %}-->
<!--            <div class="alert alert-info mt-3"><strong>ğŸ¤– æ¨¡å‹å›ç­”ï¼š </strong>{{ answer }}</div>-->
<!--            {% endif %}-->

<!--            {% if markdown_file %}-->
<!--            <div class="mt-3">-->
<!--              <a href="{{ url_for('download_markdown', filename=markdown_file) }}" class="btn btn-outline-success">-->
<!--                ğŸ“¥ ä¸‹è½½é—®ç­” Markdown-->
<!--              </a>-->
<!--            </div>-->
<!--            {% endif %}-->

<!--            {% if source_chunks %}-->
<!--            <div class="card border-info mt-4">-->
<!--              <div class="card-header bg-info text-white">ğŸ“„ å¼•ç”¨èµ„æ–™ç‰‡æ®µï¼ˆTop {{ source_chunks|length }}ï¼‰</div>-->
<!--              <div class="card-body">-->
<!--                <div class="accordion" id="ragAccordion">-->
<!--                  {% for chunk in source_chunks %}-->
<!--                  <div class="accordion-item">-->
<!--                    <h2 class="accordion-header" id="heading{{ loop.index }}">-->
<!--                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false">-->
<!--                        ğŸ“ ç‰‡æ®µ {{ loop.index }}-->
<!--                      </button>-->
<!--                    </h2>-->
<!--                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#ragAccordion">-->
<!--                      <div class="accordion-body bg-light">-->
<!--                        <pre style="white-space: pre-wrap; font-size: 14px;">{{ chunk }}</pre>-->
<!--                        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyToClipboard('chunkTxt{{ loop.index }}')">ğŸ“‹ å¤åˆ¶</button>-->
<!--                        <textarea id="chunkTxt{{ loop.index }}" class="d-none">{{ chunk }}</textarea>-->
<!--                      </div>-->
<!--                    </div>-->
<!--                  </div>-->
<!--                  {% endfor %}-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->
<!--            {% endif %}-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
      <!-- æ¨¡å‹é€‰æ‹©æ¨¡å— -->
      <div id="model-config-section" class="content-section">
        <div class="card mb-4">
          <div class="card-header">âš™ï¸ æ¨¡å‹é€‰æ‹©ä¸ API é…ç½®</div>
          <div class="card-body">
            <form action="/set_model" method="POST" class="row g-3">
              <div class="col-md-6">
                <label for="global_model" class="form-label">é€‰æ‹©ä½¿ç”¨çš„æ¨¡å‹</label>
                <select name="global_model" class="form-select">
                  <option value="local" {% if selected_model == 'local' %}selected{% endif %}>æœ¬åœ°éƒ¨ç½² DeepSeek</option>
                  <option value="openai" {% if selected_model == 'openai' %}selected{% endif %}>OpenRouter äº‘ç«¯ï¼ˆDeepSeek R1 å…è´¹ç‰ˆï¼‰</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="api_key" class="form-label">API Keyï¼ˆä»…äº‘ç«¯éœ€è¦ï¼‰</label>
                <input type="text" name="api_key" class="form-control" placeholder="è¾“å…¥ OpenRouter API Key" value="{{ api_key or '' }}">
              </div>
              <div class="col-12">
                <button class="btn btn-primary">âœ… åº”ç”¨è®¾ç½®</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- æ–‡ä»¶æ¨¡å— -->
      <div id="file-section" class="content-section">
        <div class="card mb-4">
          <div class="card-header">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</div>
          <div class="card-body">
            <form action="/create_folder" method="post" class="row g-3">
              <div class="col-md-10"><input type="text" name="folder_name" class="form-control" placeholder="è¾“å…¥æ–‡ä»¶å¤¹åç§°" required></div>
              <div class="col-md-2"><button class="btn btn-secondary w-100">åˆ›å»º</button></div>
            </form>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">ä¸Šä¼ æ–‡ä»¶ï¼ˆPDF / DOCX / TXTï¼‰</div>
          <div class="card-body">
            <form action="/upload" method="post" enctype="multipart/form-data" class="row g-3">
              <div class="col-md-4"><input type="file" name="file" class="form-control" required></div>
              <div class="col-md-4">
                <select name="folder" class="form-select" required>
                  {% for folder in folders %}<option>{{ folder }}</option>{% endfor %}
                </select>
              </div>
              <div class="col-md-4"><button class="btn btn-primary w-100">ä¸Šä¼ </button></div>
            </form>
          </div>
        </div>
        {% for folder, files in folder_files.items() %}
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>ğŸ“‚ {{ folder }}</span>
            <form action="{{ url_for('delete_folder', folder_name=folder) }}" method="post" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤æ•´ä¸ªæ–‡ä»¶å¤¹ {{ folder }} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')">
              <button type="submit" class="btn btn-sm btn-outline-danger">ğŸ—‘ åˆ é™¤æ–‡ä»¶å¤¹</button>
            </form>
          </div>
          <div class="card-body">
            {% if files %}
            <ul class="list-group">
              {% for file in files %}
              <li class="list-group-item d-flex justify-content-between">
                {{ file }}
                <span>
                  <a href="{{ url_for('view_file', folder=folder, filename=file) }}" target="_blank" class="btn btn-sm btn-outline-secondary">æŸ¥çœ‹</a>
                  <a href="{{ url_for('download_file', folder=folder, filename=file) }}" class="btn btn-sm btn-outline-primary">ä¸‹è½½</a>
                  <a href="{{ url_for('delete_file', folder=folder, filename=file) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®è®¤åˆ é™¤ {{ file }} å—ï¼Ÿ')">åˆ é™¤</a>
                </span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">ï¼ˆè¯¥æ–‡ä»¶å¤¹æš‚æ— æ–‡ä»¶ï¼‰</p>
            {% endif %}
          </div>
        </div>
        {% endfor %}

<!--        {% for folder, files in folder_files.items() %}-->
<!--        <div class="card mb-3">-->
<!--          <div class="card-header">ğŸ“‚ {{ folder }}</div>-->
<!--          <div class="card-body">-->
<!--            {% if files %}-->
<!--            <ul class="list-group">-->
<!--              {% for file in files %}-->
<!--              <li class="list-group-item d-flex justify-content-between">-->
<!--                {{ file }}-->
<!--                <span>-->
<!--                  <a href="{{ url_for('view_file', folder=folder, filename=file) }}" target="_blank" class="btn btn-sm btn-outline-secondary">æŸ¥çœ‹</a>-->
<!--                  <a href="{{ url_for('download_file', folder=folder, filename=file) }}" class="btn btn-sm btn-outline-primary">ä¸‹è½½</a>-->
<!--                  <a href="{{ url_for('delete_file', folder=folder, filename=file) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®è®¤åˆ é™¤ {{ file }} å—ï¼Ÿ')">åˆ é™¤</a>-->
<!--                </span>-->
<!--              </li>-->
<!--              {% endfor %}-->
<!--            </ul>-->
<!--            {% else %}-->
<!--            <p class="text-muted">ï¼ˆè¯¥æ–‡ä»¶å¤¹æš‚æ— æ–‡ä»¶ï¼‰</p>-->
<!--            {% endif %}-->
<!--          </div>-->
<!--        </div>-->
<!--        {% endfor %}-->
      </div>

      <!-- è¯­éŸ³æ¨¡å— -->
      <div id="voice-section" class="content-section">
        <div class="card mb-4">
          <div class="card-header">ğŸ™ï¸ æµè§ˆå™¨å½•éŸ³è¯†åˆ«æé—®</div>
          <div class="card-body">
            <button onclick="startRecording()" class="btn btn-warning">å¼€å§‹å½•éŸ³</button>
            <button onclick="stopRecording()" class="btn btn-secondary">åœæ­¢å½•éŸ³</button>
            <form id="voice-form" action="/ask_from_voice" method="post" class="mt-3">
              <input type="hidden" name="audio_blob" id="audio_blob_input">
              <button class="btn btn-success">æäº¤æé—®</button>
            </form>
            <p id="voice-status" class="mt-2 text-muted"></p>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">ğŸ“ ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æé—®</div>
          <div class="card-body">
            <form action="/ask_from_audio" method="post" enctype="multipart/form-data">
              <input type="file" name="audio_file" class="form-control" accept="audio/*" required>
              <button class="btn btn-primary mt-2">æäº¤æé—®</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Excel æ¨¡å— -->
      <div id="excel-section" class="content-section">
        <div class="card mb-4">
          <div class="card-header">ğŸ“Š ä¸Šä¼  Excel è¡¨æ ¼æé—®</div>
          <div class="card-body">
            <form action="/ask_from_excel" method="post" enctype="multipart/form-data">
              <input type="file" name="excel_file" class="form-control" accept=".xlsx,.xls" required>
              <textarea name="excel_question" class="form-control mt-2" rows="3" placeholder="è¯·è¾“å…¥å¯¹ Excel çš„é—®é¢˜..." required></textarea>
              <button class="btn btn-success mt-2">æäº¤æé—®</button>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="{{ url_for('static', filename='recorder.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function showSection(id) {
  document.querySelectorAll('.content-section').forEach(e => e.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-link').forEach(e => e.classList.remove('active'));
  event.target.classList.add('active');
}

function copyText() {
  navigator.clipboard.writeText(document.getElementById("recognized-text")?.innerText || "")
    .then(() => alert("âœ… å·²å¤åˆ¶"))
    .catch(err => alert("âŒ å¤åˆ¶å¤±è´¥ï¼š" + err));
}

function copyToClipboard(id) {
  navigator.clipboard.writeText(document.getElementById(id).value)
    .then(() => alert("âœ… ç‰‡æ®µå·²å¤åˆ¶"))
    .catch(err => alert("âŒ å¤åˆ¶å¤±è´¥ï¼š" + err));
}
</script>
<script>
  function presetQuestion(text) {
    const input = document.querySelector('input[name="question"]');
    input.value = text;
    input.focus();
  }
</script>

</body>
</html>
